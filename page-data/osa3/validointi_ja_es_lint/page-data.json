{"componentChunkName":"component---src-templates-content-template-js","path":"/osa3/validointi_ja_es_lint","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Sovelluksen tietokantaan tallettamalle datan muodolle on usein tarve asettaa joitain ehtoja. Sovelluksemme ei hyväksy esim. muistiinpanoja, joiden sisältö eli <i>content</i>-kenttä puuttuu. Muistiinpanon oikeellisuus tarkastetaan sen luovassa metodissa:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Eli jos muistiinpanolla ei ole kenttää <i>content</i>, vastataan pyyntöön statuskoodilla <i>400 Bad Request</i>. </p>\n<p>Routejen tapahtumakäsittelijöissä tehtävää tarkastusta järkevämpi tapa tietokantaan talletettavan tiedon oikean muodon määrittelylle ja tarkastamiselle on Mongoosen <a href=\"https://mongoosejs.com/docs/validation.html\">validointitoiminnallisuuden</a> käyttö.</p>\n<p>Kullekin talletettavan datan kentälle voidaan määritellä validointisääntöjä skeemassa:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  content<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    type<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    minlength<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    required<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  important<span class=\"token operator\">:</span> Boolean\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kentän <i>content</i> pituuden vaaditaan nyt olevan vähintään viisi merkkiä ja kentän arvo ei saa olla tyhjä. Kentälle <i>important</i> ei ole asetettu mitään ehtoa, joten se on määritelty edelleen yksinkertaisemmassa muodossa.</p>\n<p>Esimerkissä käytetyt validaattorit <i>minlength</i> ja <i>required</i> ovat Mongooseen <a href=\"https://mongoosejs.com/docs/validation.html#built-in-validators\">sisäänrakennettuja</a> validointisääntöjä. Mongoosen <a href=\"https://mongoosejs.com/docs/validation.html#custom-validators\">custom validator</a> -ominaisuus mahdollistaa mielivaltaisten validaattorien toteuttamisen, jos valmiiden joukosta ei löydy tarkoitukseen sopivaa.</p>\n<p>Jos tietokantaan yritetään tallettaa validointisäännön rikkova olio, heittää tallennusoperaatio poikkeuksen. Muutetaan uuden muistiinpanon luomisesta huolehtivaa käsittelijää siten, että se välittää mahdollisen poikkeuksen virheenkäsittelijämiddlewaren huolehdittavaksi:  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span>  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    content<span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    important<span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    date<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">savedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Laajennetaan virheenkäsittelijää huomioimaan validointivirheet:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'ValidationError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Validoinnin epäonnistuessa palautetaan validaattorin oletusarvoinen virheviesti:</p>\n<picture><img src=\"/static/6beb35ed56d2e06e0eda3e36dea9f426/5a190/50.png\" alt=\"Luotaessa muistiinpano jonka kenttä content on liian lyhyt, seurauksena on virheilmoituksen sisältävä JSON\" srcset=\"/static/6beb35ed56d2e06e0eda3e36dea9f426/772e8/50.png 200w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/e17e5/50.png 400w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/5a190/50.png 800w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/c1b63/50.png 1200w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/29007/50.png 1600w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/1e1c3/50.png 1670w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Huomaamme kuitenkin että sovelluksessa on pieni ongelma, validaatiota ei suoriteta muistiinpanojen päivityksen yhteydessä. <a href=\"https://github.com/blakehaswell/mongoose-unique-validator#find--updates\">Dokumentaatio</a> kertoo mistä on kyse, validaatiota ei suoriteta oletusarvoisesti metodin <i>findOneAndUpdate</i> suorituksen yhteydessä.</p>\n<p>Korjaus on onneksi helppo. Muotoillaan routea muutenkin hieman siistimmäksi:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> content<span class=\"token punctuation\">,</span> important <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndUpdate</span><span class=\"token punctuation\">(</span>\n    request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> \n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">{</span> content<span class=\"token punctuation\">,</span> important <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">{</span> <span class=\"token keyword\">new</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> runValidators<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">:</span> <span class=\"token string\">'query'</span> <span class=\"token punctuation\">}</span></span>  <span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">updatedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>updatedNote<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Tietokantaa käyttävän version vieminen tuotantoon</h3>\n<p>Sovelluksen pitäisi toimia tuotannossa eli Fly.io:ssa tai Renderissä lähes sellaisenaan. Frontendin muutosten takia on tehtävä siitä uusi tuotantoversio ja kopioitava se backendiin. </p>\n<p>Huomaa, että vaikka määrittelimme sovelluskehitystä varten ympäristömuuttujille arvot tiedostossa <i>.env</i>, tietokantaurlin kertovan ympäristömuuttujan täytyy asettaa Fly.io:n tai Render vielä erikseen.</p>\n<p>Fly.io:ssa komennolla <em>fly secrets set</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">fly secrets set MONGODB_URI=&#39;mongodb+srv://fullstack:&lt;password&gt;@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority&#39;</code></pre></div>\n<p>Kun sovellus viedään tuotantoon, on hyvin tavanomaista että kaikki ei toimi odotusten mukaan. Esim. ensimmäinen tuotantoonvientiyritykseni päätyi seuraavaan:</p>\n<picture><img src=\"/static/ba06b14a502f7da32b06c9cd2e79f97b/5a190/fly-problem1.png\" srcset=\"/static/ba06b14a502f7da32b06c9cd2e79f97b/772e8/fly-problem1.png 200w,\n/static/ba06b14a502f7da32b06c9cd2e79f97b/e17e5/fly-problem1.png 400w,\n/static/ba06b14a502f7da32b06c9cd2e79f97b/5a190/fly-problem1.png 800w,\n/static/ba06b14a502f7da32b06c9cd2e79f97b/c1b63/fly-problem1.png 1200w,\n/static/ba06b14a502f7da32b06c9cd2e79f97b/29007/fly-problem1.png 1600w,\n/static/ba06b14a502f7da32b06c9cd2e79f97b/da952/fly-problem1.png 1872w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Sovelluksessa ei toimi mikään.</p>\n<p>Selaimen konsolin network-välilehti paljastaa että yritys muistiinpanojen hakemiseksi ei onnistu, pyyntö jää pitkäksi aikaa tilaan <em>pending</em> ja lopulta epäonnistuu HTTP statuskoodilla 502.</p>\n<p>Selaimen konsolia on siis tarkasteltava <i>koko ajan!</i></p>\n<p>Myös palvelimen lokien seuraaminen on elintärkeää. Ongelman syy selviääkin heti kun katsomme komennolla <em>fly logs</em> mitä palvelimella tapahtuu:</p>\n<picture><img src=\"/static/92ac2c6e2e4d0f84bb7a5a5317708d75/5a190/fly-problem3.png\" srcset=\"/static/92ac2c6e2e4d0f84bb7a5a5317708d75/772e8/fly-problem3.png 200w,\n/static/92ac2c6e2e4d0f84bb7a5a5317708d75/e17e5/fly-problem3.png 400w,\n/static/92ac2c6e2e4d0f84bb7a5a5317708d75/5a190/fly-problem3.png 800w,\n/static/92ac2c6e2e4d0f84bb7a5a5317708d75/c1b63/fly-problem3.png 1200w,\n/static/92ac2c6e2e4d0f84bb7a5a5317708d75/29007/fly-problem3.png 1600w,\n/static/92ac2c6e2e4d0f84bb7a5a5317708d75/7970d/fly-problem3.png 1908w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Tietokannan osoite on siis <em>undefined</em>, eli komento <em>fly secrets set MONGODB_URI</em> oli unohtunut.</p>\n<p>Renderiä käytettäessä tietokannan osoitteen kertova ympäristömuuttuja määritellään dashboardista käsin:</p>\n<picture><img src=\"/static/ae7c73092becbbef8aa45299e9b8fbcd/5a190/render-env.png\" srcset=\"/static/ae7c73092becbbef8aa45299e9b8fbcd/772e8/render-env.png 200w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/e17e5/render-env.png 400w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/5a190/render-env.png 800w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/c1b63/render-env.png 1200w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/29007/render-env.png 1600w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/97a96/render-env.png 2400w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Renderiä käytettäessä sovelluksen lokia on mahdollista tarkastella\nDashboardin kautta:</p>\n<picture><img src=\"/static/798d2488fb450327abf2b6729faaaeec/5a190/r7.png\" srcset=\"/static/798d2488fb450327abf2b6729faaaeec/772e8/r7.png 200w,\n/static/798d2488fb450327abf2b6729faaaeec/e17e5/r7.png 400w,\n/static/798d2488fb450327abf2b6729faaaeec/5a190/r7.png 800w,\n/static/798d2488fb450327abf2b6729faaaeec/c1b63/r7.png 1200w,\n/static/798d2488fb450327abf2b6729faaaeec/29007/r7.png 1600w,\n/static/798d2488fb450327abf2b6729faaaeec/b5c8e/r7.png 2194w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-6\">GitHubissa</a>, branchissä <i>part3-6</i>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Tehtävät 3.19.-3.21.</h3>\n<h4>3.19: puhelinluettelo ja tietokanta, step7</h4>\n<p>Laajenna validaatiota siten, että tietokantaan talletettavan nimen on oltava pituudeltaan vähintään kolme merkkiä. </p>\n<p>Laajenna sovelluksen frontendia siten, että se antaa jonkinlaisen virheilmoituksen validoinnin epäonnistuessa. Virheidenkäsittely hoidetaan lisäämällä <em>catch</em>-lohko uuden henkilön lisäämisen yhteyteen:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">personService\n    <span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">createdPerson</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// pääset käsiksi palvelimen palauttamaan virheilmoitusolioon näin</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Voit näyttää frontendissa käyttäjälle Mongoosen validoinnin oletusarvoisen virheilmoituksen vaikka ne eivät olekaan luettavuudeltaan parhaat mahdolliset:</p>\n<picture><img src=\"/static/fddf847e340f060549c3029f464a5493/5a190/56e.png\" alt=\"Selain renderöi virheilmoituksen &#x27;Person valiation failed: name...&#x27;\" srcset=\"/static/fddf847e340f060549c3029f464a5493/772e8/56e.png 200w,\n/static/fddf847e340f060549c3029f464a5493/e17e5/56e.png 400w,\n/static/fddf847e340f060549c3029f464a5493/5a190/56e.png 800w,\n/static/fddf847e340f060549c3029f464a5493/c1b63/56e.png 1200w,\n/static/fddf847e340f060549c3029f464a5493/29007/56e.png 1600w,\n/static/fddf847e340f060549c3029f464a5493/f4fb1/56e.png 1766w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>3.20*: puhelinluettelo ja tietokanta, step8</h4>\n<p>Toteuta sovelluksellesi validaatio, joka huolehtii, että backendiin voi tallettaa ainoastaan oikeassa muodossa olevia puhelinnumeroita. Puhelinnumeron täytyy olla</p>\n<ul>\n<li>vähintään 8 merkkiä pitkä</li>\n<li>\n<p>koostua kahdesta väliviivalla erotetusta osasta joissa ensimmäisessä osassa on 2 tai 3 numeroa ja toisessa osassa riittävä määrä numeroita</p>\n<ul>\n<li>esim. 09-1234556 ja 040-22334455 ovat oikeassa muodossa</li>\n<li>esim. 1234556, 1-22334455 ja 10-22-334455 eivät ole kelvollisia</li>\n</ul>\n</li>\n</ul>\n<p>Toteuta validoinnin toinen osa <a href=\"https://mongoosejs.com/docs/validation.html#custom-validators\">Custom validationina</a>.</p>\n<p>Jos HTTP POST -pyyntö yrittää lisätä virheellistä numeroa, tulee vastata sopivalla statuskoodilla ja lisätä vastaukseen asianmukainen virheilmoitus.</p>\n<h4>3.21 tietokantaa käyttävä versio Internetiin</h4>\n<p>Generoi päivitetystä sovelluksesta \"full stack\" -versio, eli tee frontendista uusi production build ja kopioi se backendin repositorioon. Varmista, että kaikki toimii paikallisesti käyttämällä koko sovellusta backendin osoitteesta <a href=\"http://localhost:3001\">http://localhost:3001</a>.</p>\n<p>Pushaa uusi versio Fly.io:n tai Renderiin ja varmista, että kaikki toimii myös siellä.</p>\n</div>\n<div class=\"content\">\n<h3>Lint</h3>\n<p>Ennen osan lopetusta katsomme vielä nopeasti paitsioon jäänyttä tärkeää työkalua <a href=\"https://en.wikipedia.org/wiki/Lint_(software)\">lintiä</a>. Wikipedian sanoin:</p>\n<blockquote>\n<p><i>Generically, lint or a linter is any tool that detects and flags errors in programming languages, including stylistic errors. The term lint-like behavior is sometimes applied to the process of flagging suspicious language usage. Lint-like tools generally perform static analysis of source code.</i></p>\n</blockquote>\n<p>Staattisesti tyypitetyissä, käännettävissä kielissä (esim. Javassa) ohjelmointiympäristöt, kuten NetBeans osaavat huomautella monista koodiin liittyvistä asioista, sellaisistakin, jotka eivät ole välttämättä käännösvirheitä. Erilaisten <a href=\"https://en.wikipedia.org/wiki/Static_program_analysis\">staattisen analyysin</a> lisätyökalujen, kuten <a href=\"https://checkstyle.sourceforge.io/\">checkstylen</a> avulla voidaan vielä laajentaa Javassa huomautettavien asioiden määrää koskemaan koodin tyylillisiä seikkoja, esim. sisentämistä.</p>\n<p>JavaScript-maailmassa tämän hetken johtava työkalu staattiseen analyysiin eli \"linttaukseen\" on <a href=\"https://eslint.org/\">ESLint</a>.</p>\n<p>Asennetaan ESLint backendiin kehitysaikaiseksi riippuvuudeksi:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> eslint --save-dev</code></pre></div>\n<p>Tämän jälkeen voidaan muodostaa alustava ESLint-konfiguraatio:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx eslint --init</code></pre></div>\n<p>Vastaillaan kysymyksiin:</p>\n<picture><img src=\"/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/5a190/52new.png\" alt=\"Vastataan kysymyksiin koodin luonteen mukaan, erityisesti että kyse ei ole TypeSriptistä, käytetään &#x27; merkkijonoissa, ei käytetä ; rivien lopussa\" srcset=\"/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/772e8/52new.png 200w,\n/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/e17e5/52new.png 400w,\n/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/5a190/52new.png 800w,\n/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/c1b63/52new.png 1200w,\n/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/29007/52new.png 1600w,\n/static/a7cfec0c6a43ac7e5580e7ea1a9b0260/fb937/52new.png 1820w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Konfiguraatiot tallentuvat tiedostoon <em>.eslintrc.js</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'env'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'commonjs'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'es2021'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token string\">'node'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'extends'</span><span class=\"token operator\">:</span> <span class=\"token string\">'eslint:recommended'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'parserOptions'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'ecmaVersion'</span><span class=\"token operator\">:</span> <span class=\"token string\">'latest'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'rules'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'indent'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token number\">4</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'linebreak-style'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'unix'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'quotes'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'single'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'semi'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'never'</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Tarkista, että tiedostossa on rivi 'node': true kuvanmukaisesti ja lisää se tarvittaessa.</p>\n<p>Muutetaan heti konfiguraatioista sisennystä määrittelevä sääntö siten, että sisennystaso on kaksi välilyöntiä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">\"indent\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">2</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Esim tiedoston <em>index.js</em> tarkastus tapahtuu komennolla:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx eslint index.js</code></pre></div>\n<p>Kannattaa ehkä tehdä linttaustakin varten <em>npm-skripti</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node index.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nodemon index.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eslint .\"</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nyt komento <em>npm run lint</em> suorittaa tarkastukset koko projektille.</p>\n<p>Myös hakemistossa <em>build</em> oleva frontendin tuotantoversio tulee näin tarkastettua. Sitä emme kuitenkaan halua, eli tehdään projektin juureen tiedosto <a href=\"https://eslint.org/docs/user-guide/configuring/ignoring-code#the-eslintignore-file\">.eslintignore</a> ja sille seuraava sisältö:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">build</code></pre></div>\n<p>Näin koko hakemiston <em>build</em> sisältö jätetään huomioimatta linttauksessa.</p>\n<p>Lintillä on jonkin verran huomautettavaa koodistamme:</p>\n<picture><img src=\"/static/cdf7d27db507f48c4ab9f7bd59f8071f/5a190/53ea.png\" alt=\"Lint kertoo kolmesta virheestä, kaikki muuttujia joille ei ole käyttöä\" srcset=\"/static/cdf7d27db507f48c4ab9f7bd59f8071f/772e8/53ea.png 200w,\n/static/cdf7d27db507f48c4ab9f7bd59f8071f/e17e5/53ea.png 400w,\n/static/cdf7d27db507f48c4ab9f7bd59f8071f/5a190/53ea.png 800w,\n/static/cdf7d27db507f48c4ab9f7bd59f8071f/c1b63/53ea.png 1200w,\n/static/cdf7d27db507f48c4ab9f7bd59f8071f/d7ceb/53ea.png 1446w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Ei kuitenkaan korjata ongelmia vielä.</p>\n<p>Parempi vaihtoehto linttauksen suorittamiselle komentoriviltä on konfiguroida editorille <i>eslint-plugin</i>, joka suorittaa linttausta koko ajan. Näin pääset korjaamaan pienet virheet välittömästi. Tietoja esim. Visual Studion ESLint-pluginista on <a href=\"https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint\">täällä</a>.</p>\n<p>VS Coden ESLint-plugin alleviivaa tyylisääntöjä rikkovat kohdat punaisella:</p>\n<picture><img src=\"/static/64cf2fbae36000083aa1e48292aed8f2/5a190/54a.png\" alt=\"Havainnollistus siitä miten VS code merkkaa rivit, joilla on eslint-tyylirike\" srcset=\"/static/64cf2fbae36000083aa1e48292aed8f2/772e8/54a.png 200w,\n/static/64cf2fbae36000083aa1e48292aed8f2/e17e5/54a.png 400w,\n/static/64cf2fbae36000083aa1e48292aed8f2/5a190/54a.png 800w,\n/static/64cf2fbae36000083aa1e48292aed8f2/c1b63/54a.png 1200w,\n/static/64cf2fbae36000083aa1e48292aed8f2/29007/54a.png 1600w,\n/static/64cf2fbae36000083aa1e48292aed8f2/17009/54a.png 1932w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Näin ongelmat on helppo korjata koodiin heti.</p>\n<p>Komento <em>npm run lint -- --fix</em> voi olla avuksi, jos koodissa on esim. useampia syntaksivirheitä.</p>\n<p>ESLintille on määritelty suuri määrä <a href=\"https://eslint.org/docs/rules/\">sääntöjä</a>, joita on helppo ottaa käyttöön muokkaamalla tiedostoa <i>.eslintrc.js</i>.</p>\n<p>Otetaan käyttöön sääntö <a href=\"https://eslint.org/docs/rules/eqeqeq\">eqeqeq</a> joka varoittaa, jos koodissa yhtäsuuruutta verrataan muuten kuin käyttämällä kolmea = -merkkiä. Sääntö lisätään konfiguraatiotiedostoon kentän <i>rules</i> alle.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token string\">'rules'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n   <span class=\"token string\">'eqeqeq'</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Tehdään samalla muutama muukin muutos tarkastettaviin sääntöihin.</p>\n<p>Estetään rivien lopussa olevat <a href=\"https://eslint.org/docs/rules/no-trailing-spaces\">turhat välilyönnit</a>, vaaditaan että <a href=\"https://eslint.org/docs/rules/object-curly-spacing\">aaltosulkeiden edessä/jälkeen on aina välilyönti</a> ja vaaditaan myös konsistenttia välilyöntien käyttöä <a href=\"https://eslint.org/docs/rules/arrow-spacing\">nuolifunktioiden parametrien suhteen</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token string\">'rules'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token string\">'eqeqeq'</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'no-trailing-spaces'</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'object-curly-spacing'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'always'</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'arrow-spacing'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'before'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'after'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Oletusarvoinen konfiguraatiomme ottaa käyttöön joukon valmiiksi määriteltyjä sääntöjä (<i>eslint:recommended</i>):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token string\">'extends'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'eslint:recommended'</span>,</code></pre></div>\n<p>Mukana on myös <em>console.log</em>-komennoista varoittava sääntö.</p>\n<p>Yksittäinen sääntö on helppo kytkeä <a href=\"https://eslint.org/docs/user-guide/configuring/rules#configuring-rules\">pois päältä</a> määrittelemällä sen \"arvoksi\" konfiguraatiossa 0. Tehdään toistaiseksi näin säännölle <i>no-console</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token string\">'rules'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...</span>\n      <span class=\"token string\">'eqeqeq'</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'no-trailing-spaces'</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'object-curly-spacing'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'always'</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'arrow-spacing'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'before'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'after'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">'no-console'</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>HUOM:</strong> Kun teet muutoksia tiedostoon <i>.eslintrc.js</i>, kannattaa muutosten jälkeen suorittaa linttaus komentoriviltä ja varmistaa, että konfiguraatio ei ole viallinen:</p>\n<picture><img src=\"/static/683365a382c607616d65e603f8d8d39a/5a190/55.png\" alt=\"Suoritetaan npm run lint...\" srcset=\"/static/683365a382c607616d65e603f8d8d39a/772e8/55.png 200w,\n/static/683365a382c607616d65e603f8d8d39a/e17e5/55.png 400w,\n/static/683365a382c607616d65e603f8d8d39a/5a190/55.png 800w,\n/static/683365a382c607616d65e603f8d8d39a/c1b63/55.png 1200w,\n/static/683365a382c607616d65e603f8d8d39a/29007/55.png 1600w,\n/static/683365a382c607616d65e603f8d8d39a/7575b/55.png 1608w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Jos konfiguraatiossa on jotain vikaa, voi editorin lint-plugin näyttää mitä sattuu.</p>\n<p>Monissa yrityksissä on tapana määritellä yrityksen laajuiset koodausstandardit ja näiden käyttöä valvova ESLint-konfiguraatio. Pyörää ei kannata välttämättä keksiä uudelleen, ja voi olla hyvä idea ottaa omaan projektiin käyttöön joku jossain muualla hyväksi havaittu konfiguraatio. Viime aikoina monissa projekteissa on omaksuttu AirBnB:n <a href=\"https://github.com/airbnb/javascript\">JavaScript</a>-tyyliohjeet ottamalla käyttöön firman määrittelemä <a href=\"https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb\">ESLint</a>-konfiguraatio.</p>\n<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-7\">GitHubissa</a>, branchissa <i>part3-7</i>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Tehtävä 3.22.</h3>\n<h4>3.22: lint-konfiguraatio</h4>\n<p>Ota sovellukseesi käyttöön ESLint, ja korjaa kaikki tyylivirheet.</p>\n<p>Tämä oli osan viimeinen tehtävä, joten on aika pushata koodi GitHubiin sekä merkata tehdyt tehtävät <a href=\"https://study.cs.helsinki.fi/stats/courses/fullstack2023\">palautussovellukseen</a>.</p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/8ac7bc0fb2b7018a7853b00c454b2103/part-3.svg"},"part":3,"letter":"d","lang":"fi"}}},"pageContext":{"part":3,"letter":"d","lang":"fi"}},"staticQueryHashes":["3128451518"]}