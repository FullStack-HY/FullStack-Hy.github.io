{"componentChunkName":"component---src-templates-content-template-js","path":"/en/part3/deploying_app_to_internet","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Next, let's connect the frontend we made in <a href=\"/en/part2\">part 2</a> to our own backend.</p>\n<p>In the previous part, the frontend could ask for the list of notes from the json-server we had as a backend, from the address <a href=\"http://localhost:3001/notes\">http://localhost:3001/notes</a>.\nOur backend has a slightly different URL structure now, as the notes can be found at <a href=\"http://localhost:3001/api/notes\">http://localhost:3001/api/notes</a>. Let's change the attribute <strong>baseUrl</strong> in the <i>src/services/notes.js</i> like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'http://localhost:3001/api/notes'</span></span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getAll</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>baseUrl<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span> getAll<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> update <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now frontend's GET request to <a href=\"http://localhost:3001/api/notes\">http://localhost:3001/api/notes</a> does not work for some reason:</p>\n<picture><img src=\"/static/da88e17cb078c89a6e7ba30d61fab0e6/5a190/3ae.png\" alt=\"Get request showing error in dev tools\" srcset=\"/static/da88e17cb078c89a6e7ba30d61fab0e6/772e8/3ae.png 200w,\n/static/da88e17cb078c89a6e7ba30d61fab0e6/e17e5/3ae.png 400w,\n/static/da88e17cb078c89a6e7ba30d61fab0e6/5a190/3ae.png 800w,\n/static/da88e17cb078c89a6e7ba30d61fab0e6/c1b63/3ae.png 1200w,\n/static/da88e17cb078c89a6e7ba30d61fab0e6/29007/3ae.png 1600w,\n/static/da88e17cb078c89a6e7ba30d61fab0e6/6e29b/3ae.png 1610w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>What's going on here? We can access the backend from a browser and from postman without any problems.</p>\n<h3>Same origin policy and CORS</h3>\n<p>The issue lies with a thing called <code class=\"language-text\">same origin policy</code>. A URL's origin is defined by the combination of protocol (AKA scheme), hostname, and port.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http://example.com:80/index.html\n  \nprotocol: http\nhost: example.com\nport: 80</code></pre></div>\n<p>When you visit a website (i.e <a href=\"http://catwebsites.com\">http://catwebsites.com</a>), the browser issues a request to the server on which the webiste (catwebsites.com) is hosted. The response sent by the server is an HTML file that may contain one or more references to external assets/resources hosted either on the same server that <i>catwebsites.com</i> is hosted on or a different website. When the browser sees reference(s) to a URL in the source HTML, it issues a request. If the request is issued using the URL that the source HTML was fetched from, then the browser processes the response without any issues. However, if the resource is fetched using a URL that doesn't share the same origin(scheme, host, port) as the source HTML, the browser will have to check the <code class=\"language-text\">Access-Control-Allow-origin</code> response header. If it contains <code class=\"language-text\">*</code> or the URL of the source HTML, the browser will process the response, otherwise the browser will refuse to process it and throw an error.</p>\n<p>The <strong>same-origin policy</strong> is a security mechanism implemented by browsers in order to prevent session hijacking among other security vulnerabilities.</p>\n<p>In order to enable legitimate cross-origin requests (requests to URLs that don't share the same origin) W3C came up with a mechanism called <strong>CORS</strong>(Cross-Origin Resource Sharing). According to <a href=\"https://en.wikipedia.org/wiki/Cross-origin_resource_sharing\">Wikipedia</a>:</p>\n<blockquote>\n<p><i>Cross-origin resource sharing (CORS) is a mechanism that allows restricted resources (e.g. fonts) on a web page to be requested from another domain outside the domain from which the first resource was served. A web page may freely embed cross-origin images, stylesheets, scripts, iframes, and videos. Certain \"cross-domain\" requests, notably Ajax requests, are forbidden by default by the same-origin security policy.</i></p>\n</blockquote>\n<p>The problem is that, by default, the JavaScript code of an application that runs in a browser can only communicate with a server in the same <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">origin</a>.\nBecause our server is in localhost port 3001, while our frontend is in localhost port 3000, they do not have the same origin.</p>\n<p>Keep in mind, that <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">same-origin policy</a> and CORS are not specific to React or Node. They are universal principles regarding the safe operation of web applications. </p>\n<p>We can allow requests from other <i>origins</i> by using Node's <a href=\"https://github.com/expressjs/cors\">cors</a> middleware.</p>\n<p>In your backend repository, install <i>cors</i> with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> cors</code></pre></div>\n<p>take the middleware to use and allow for requests from all origins: </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> cors <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cors'</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>And the frontend works! However, the functionality for changing the importance of notes has not yet been implemented on the backend. </p>\n<p>You can read more about CORS from <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\">Mozilla's page</a>.</p>\n<p>The setup of our app looks now as follows:</p>\n<picture><img src=\"/static/6b5dfae8a726cba417c2f2ed4170d9af/664c8/100.png\" alt=\"diagram of react app and browser\" srcset=\"/static/6b5dfae8a726cba417c2f2ed4170d9af/772e8/100.png 200w,\n/static/6b5dfae8a726cba417c2f2ed4170d9af/e17e5/100.png 400w,\n/static/6b5dfae8a726cba417c2f2ed4170d9af/664c8/100.png 524w\" sizes=\"(max-width: 524px) 100vw, 524px\"></picture>\n<p>The react app running in the browser now fetches the data from node/express-server that runs in localhost:3001.</p>\n<h3>Application to the Internet</h3>\n<p>Now that the whole stack is ready, let's move our application to the internet.</p>\n<p>There are an ever-growing number of services that can be used to host an app on the internet. The developer-friendly services like PaaS (i.e. Platform as a Service) take care of installing the execution environment (eg. Node.js) and could also provide various services such as databases.</p>\n<p>For a decade, <a href=\"http://heroku.com\">Heroku</a> was dominating the PaaS scene. Unfortunately the free tier Heroku ended at 27th November 2022. This is very unfortunate for many developers, especially students. Heroku is still very much a viable option if you are willing to spend some money. They also have <a href=\"https://www.heroku.com/students\">a student program</a> that provides some free credits.</p>\n<p>We are now introducing two services <a href=\"https://fly.io/\">Fly.io</a> and <a href=\"https://render.com/\">Render</a> that both have a (limited) free plan. Fly.io is our \"official\" hosting service since it can be for sure used also on the parts 11 and 13 of the course. Render will be fine at least for the other parts of this course.</p>\n<p>Note that despite using the free tier only, Fly.io <i>might</i> require one to enter the credit card details. At the moment Render can be used without a credit card.</p>\n<p>Render might be a bit easier to use since it does not require any software to be installed on your machine.</p>\n<p>There are also some other free options hosting options that work well for this course, at least for all parts other than part 11 (CI/CD) that might have one tricky exercise for other platforms.</p>\n<p>Some course participants have also used the following</p>\n<ul>\n<li><a href=\"https://railway.app/\">Railway</a></li>\n<li><a href=\"https://www.cyclic.sh/\">Cyclic</a></li>\n<li><a href=\"https://replit.com\">Replit</a></li>\n<li><a href=\"https://codesandbox.io\">CodeSandBox</a></li>\n</ul>\n<p>If you know some other good and easy-to-use services for hosting NodeJS, please let us know!</p>\n<p>For both Fly.io and Render, we need to change the definition of the port our application uses at the bottom of the <i>index.js</i> file like so: </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token number\">3001</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Now we are using the port defined in the <a href=\"https://en.wikipedia.org/wiki/Environment_variable\">environment variable</a> <em>PORT</em> or port 3001 if the environment variable <em>PORT</em> is undefined. Fly.io and Render configure the application port based on that environment variable. </p>\n<h4>Fly.io</h4>\n<p><i>Note that you may need to give your credit card number to Fly.io even if you are using only the free tier!</i> There has been actually conflicting reports about this, it is known for a fact that some of the students in this course are using Fly.io without entering the credit card info. At the moment <a href=\"https://render.com/\">Render</a> can be used without a credit card.</p>\n<p>By default, everyone gets two free virtual machines that can be used for running two apps at the same time. </p>\n<p>If you decide to use <a href=\"https://fly.io/\">Fly.io</a> begin by installing their flyctl executable following <a href=\"https://fly.io/docs/hands-on/install-flyctl/\">this guide</a>. After that, you should <a href=\"https://fly.io/docs/hands-on/sign-up/\">create a Fly.io account</a>. </p>\n<p>Start by <a href=\"https://fly.io/docs/hands-on/sign-in/\">authenticating</a> via the command line with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly auth login</code></pre></div>\n<p><em>Note</em> if the command <em>fly</em> does not work on your machine, you can try the longer version <em>flyctl</em>. Eg. on MacOS, both forms of the command work.</p>\n<p><i>If you do not get the flyctl to work in your machine, you could try Render (see next section), it does not require anything to be installed in your machine.</i></p>\n<p>Initializing an app happens by running the following command in the root directory of the backend app</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly launch</code></pre></div>\n<p>Give the app a name or let Fly.io auto-generate one. Pick a region where the app will be run. Do not create a Postgres database for the app and do not create an Upstash Redis database, since these are not needed.</p>\n<p>The last question is \"Would you like to deploy now?\". We should answer \"no\" since we are not quite ready yet.</p>\n<p>Fly.io creates a file <i>fly.toml</i> in the root of your app where the app is configured. To get the app up and running we <i>might</i> need to do a small addition to the part [env] of the configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span>\n  PORT <span class=\"token operator\">=</span> <span class=\"token string\">\"8080\"</span> <span class=\"token comment\"># add this</span>\n\n<span class=\"token punctuation\">[</span>experimental<span class=\"token punctuation\">]</span>\n  auto_rollback <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>services<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  http_checks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  internal_port <span class=\"token operator\">=</span> <span class=\"token number\">8080</span> \n  processes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>We have now defined in the part [env] that environment variable PORT will get the correct port (defined in part [services]) where the app should create the server. Note that the definition might be already there, but some times it has been missing.</p>\n<p>We are now ready to deploy the app to the Fly.io servers. That is done with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly deploy</code></pre></div>\n<p>If all goes well, the app should now be up and running. You can open it in the browser with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly <span class=\"token function\">open</span></code></pre></div>\n<p>After the initial setup, when the app code has been updated, it can be deployed to production with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly deploy</code></pre></div>\n<p>A particularly important command is <em>fly logs</em>. This command can be used to view server logs. It is best to keep logs always visible!</p>\n<p><strong>Note:</strong> In some cases (the cause is so far unknown) running Fly.io commands especially on Windows WSL has caused problems. If the following command just hangs</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">flyctl <span class=\"token function\">ping</span> -o personal</code></pre></div>\n<p>your computer can not for some reason connect to Fly.io. If this happens to you, <a href=\"https://github.com/fullstack-hy2020/misc/blob/master/fly_io_problem.md\">this</a> describes one possible way to proceed.</p>\n<p>If the output of the below command looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ flyctl <span class=\"token function\">ping</span> -o personal\n<span class=\"token number\">35</span> bytes from fdaa:0:8a3d::3 <span class=\"token punctuation\">(</span>gateway<span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">65</span>.1ms\n<span class=\"token number\">35</span> bytes from fdaa:0:8a3d::3 <span class=\"token punctuation\">(</span>gateway<span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">28</span>.5ms\n<span class=\"token number\">35</span> bytes from fdaa:0:8a3d::3 <span class=\"token punctuation\">(</span>gateway<span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">29</span>.3ms\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>then there are no connection problems!</p>\n<h4>Render</h4>\n<p>The following assumes that the <a href=\"https://dashboard.render.com/\">sign in</a> has be made with a GitHub account.</p>\n<p>After signing in, let us create a new \"web service\":</p>\n<picture><img src=\"/static/918351e5ad479c327ac578c0743a0811/5a190/r1.png\" srcset=\"/static/918351e5ad479c327ac578c0743a0811/772e8/r1.png 200w,\n/static/918351e5ad479c327ac578c0743a0811/e17e5/r1.png 400w,\n/static/918351e5ad479c327ac578c0743a0811/5a190/r1.png 800w,\n/static/918351e5ad479c327ac578c0743a0811/c1b63/r1.png 1200w,\n/static/918351e5ad479c327ac578c0743a0811/29007/r1.png 1600w,\n/static/918351e5ad479c327ac578c0743a0811/5ab15/r1.png 2446w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>The app repository is then connected to Render:</p>\n<picture><img src=\"/static/75040aae9bcb08b7aa53fd201ed900a9/5a190/r2.png\" srcset=\"/static/75040aae9bcb08b7aa53fd201ed900a9/772e8/r2.png 200w,\n/static/75040aae9bcb08b7aa53fd201ed900a9/e17e5/r2.png 400w,\n/static/75040aae9bcb08b7aa53fd201ed900a9/5a190/r2.png 800w,\n/static/75040aae9bcb08b7aa53fd201ed900a9/c1b63/r2.png 1200w,\n/static/75040aae9bcb08b7aa53fd201ed900a9/29007/r2.png 1600w,\n/static/75040aae9bcb08b7aa53fd201ed900a9/966c1/r2.png 1694w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>The connecting seem to require that the app reopository is public.</p>\n<p>Next we will define the basic configurations. If the app is <i>not</i> at the root of the repository the <i>Root directory</i> needs to be given a proper value:</p>\n<picture><img src=\"/static/8411e07f2b7ee2665f61341b7253e49f/5a190/r3.png\" srcset=\"/static/8411e07f2b7ee2665f61341b7253e49f/772e8/r3.png 200w,\n/static/8411e07f2b7ee2665f61341b7253e49f/e17e5/r3.png 400w,\n/static/8411e07f2b7ee2665f61341b7253e49f/5a190/r3.png 800w,\n/static/8411e07f2b7ee2665f61341b7253e49f/c1b63/r3.png 1200w,\n/static/8411e07f2b7ee2665f61341b7253e49f/29007/r3.png 1600w,\n/static/8411e07f2b7ee2665f61341b7253e49f/97a96/r3.png 2400w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>After this, the app starts up in the Render. The dashboard tells us the app state and the url where the app is running:</p>\n<picture><img src=\"/static/4a478e6ef9229324ff606f2ada7b0b46/5a190/r4.png\" srcset=\"/static/4a478e6ef9229324ff606f2ada7b0b46/772e8/r4.png 200w,\n/static/4a478e6ef9229324ff606f2ada7b0b46/e17e5/r4.png 400w,\n/static/4a478e6ef9229324ff606f2ada7b0b46/5a190/r4.png 800w,\n/static/4a478e6ef9229324ff606f2ada7b0b46/c1b63/r4.png 1200w,\n/static/4a478e6ef9229324ff606f2ada7b0b46/29007/r4.png 1600w,\n/static/4a478e6ef9229324ff606f2ada7b0b46/60ab9/r4.png 2450w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>According to the <a href=\"https://render.com/docs/deploys\">documentation</a> every commit to GitHub should redeploy the app. For some reason this is not always working.</p>\n<p>Fortunately it is also possible to manually redeploy the app:</p>\n<picture><img src=\"/static/b87d1b6ab7339294ad1f00453155e733/5a190/r5.png\" srcset=\"/static/b87d1b6ab7339294ad1f00453155e733/772e8/r5.png 200w,\n/static/b87d1b6ab7339294ad1f00453155e733/e17e5/r5.png 400w,\n/static/b87d1b6ab7339294ad1f00453155e733/5a190/r5.png 800w,\n/static/b87d1b6ab7339294ad1f00453155e733/c1b63/r5.png 1200w,\n/static/b87d1b6ab7339294ad1f00453155e733/29007/r5.png 1600w,\n/static/b87d1b6ab7339294ad1f00453155e733/79538/r5.png 2530w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Also the app logs can be seen in the dashboard:</p>\n<picture><img src=\"/static/798d2488fb450327abf2b6729faaaeec/5a190/r7.png\" srcset=\"/static/798d2488fb450327abf2b6729faaaeec/772e8/r7.png 200w,\n/static/798d2488fb450327abf2b6729faaaeec/e17e5/r7.png 400w,\n/static/798d2488fb450327abf2b6729faaaeec/5a190/r7.png 800w,\n/static/798d2488fb450327abf2b6729faaaeec/c1b63/r7.png 1200w,\n/static/798d2488fb450327abf2b6729faaaeec/29007/r7.png 1600w,\n/static/798d2488fb450327abf2b6729faaaeec/b5c8e/r7.png 2194w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>We notice now from the logs that the app has been started in the port 10000. The app code gets the right port through the environment variable PORT so it is essential that the file <i>index.js</i> has been updated as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token number\">3001</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Frontend production build</h3>\n<p>So far we have been running React code in <i>development mode</i>. In development mode the application is configured to give clear error messages, immediately render code changes to the browser, and so on. </p>\n<p>When the application is deployed, we must create a <a href=\"https://reactjs.org/docs/optimizing-performance.html#use-the-production-build\">production build</a> or a version of the application which is optimized for production. </p>\n<p>A production build of applications created with <i>create-react-app</i> can be created with the command <a href=\"https://github.com/facebookincubator/create-react-app#npm-run-build-or-yarn-build\">npm run build</a>.</p>\n<p>Let's run this command from the <i>root of the frontend project</i>.</p>\n<p>This creates a directory called <i>build</i> (which contains the only HTML file of our application, <i>index.html</i> ) which contains the directory <i>static</i>. <a href=\"https://en.wikipedia.org/wiki/Minification_(programming)\">Minified</a> version of our application's JavaScript code will be generated in the <i>static</i> directory. Even though the application code is in multiple files, all of the JavaScript will be minified into one file. All of the code from all of the application's dependencies will also be minified into this single file. </p>\n<p>The minified code is not very readable. The beginning of the code looks like this: </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">!</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">function</span> <span class=\"token function\">r</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> n<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">,</span>i<span class=\"token operator\">=</span>r<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>l<span class=\"token operator\">=</span>r<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>a<span class=\"token operator\">=</span>r<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>c<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>s<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>c<span class=\"token operator\">&lt;</span>i<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>c<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>f<span class=\"token operator\">=</span>i<span class=\"token punctuation\">[</span>c<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token operator\">&amp;&amp;</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>n <span class=\"token keyword\">in</span> l<span class=\"token punctuation\">)</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>l<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">&amp;&amp;</span><span class=\"token function\">p</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">return</span> u<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span>a<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token keyword\">function</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> e<span class=\"token punctuation\">,</span>r<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>r<span class=\"token operator\">&lt;</span>u<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>r<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> t<span class=\"token operator\">=</span>u<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>n<span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>i<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>t<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span> l<span class=\"token operator\">=</span>t<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token number\">0</span><span class=\"token operator\">!==</span>o<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span><span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>n<span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>r<span class=\"token operator\">--</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>e<span class=\"token operator\">=</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>s<span class=\"token operator\">=</span>t<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token keyword\">return</span> e<span class=\"token punctuation\">}</span><span class=\"token keyword\">var</span> n<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>o<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">2</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>u<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">function</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">return</span> n<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span><span class=\"token keyword\">var</span> t<span class=\"token operator\">=</span>n<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>i<span class=\"token operator\">:</span>r<span class=\"token punctuation\">,</span>l<span class=\"token operator\">:</span><span class=\"token operator\">!</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>exports<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">return</span> e<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>l<span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">}</span>f<span class=\"token punctuation\">.</span>m<span class=\"token operator\">=</span>e<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">.</span>c<span class=\"token operator\">=</span>n<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">d</span><span class=\"token operator\">=</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">,</span>t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">o</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">)</span><span class=\"token operator\">||</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>enumerable<span class=\"token operator\">:</span><span class=\"token operator\">!</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>get<span class=\"token operator\">:</span>t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">r</span><span class=\"token operator\">=</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"undefined\"</span><span class=\"token operator\">!==</span><span class=\"token keyword\">typeof</span> Symbol<span class=\"token operator\">&amp;&amp;</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token operator\">&amp;&amp;</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>value<span class=\"token operator\">:</span><span class=\"token string\">\"Module\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Serving static files from the backend</h3>\n<p>One option for deploying the frontend is to copy the production build (the <i>build</i> directory) to the root of the backend repository and configure the backend to show the frontend's <i>main page</i> (the file <i>build/index.html</i>) as its main page. </p>\n<p>We begin by copying the production build of the frontend to the root of the backend. With a Mac or Linux computer, the copying can be done from the frontend directory with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cp</span> -r build <span class=\"token punctuation\">..</span>/backend</code></pre></div>\n<p>If you are using a Windows computer, you may use either <a href=\"https://www.windows-commandline.com/windows-copy-command-syntax-examples/\">copy</a> or <a href=\"https://www.windows-commandline.com/xcopy-command-syntax-examples/\">xcopy</a> command instead. Otherwise, simply copy and paste. </p>\n<p>The backend directory should now look as follows:</p>\n<picture><img src=\"/static/601890ece56718617e3d3e7b91bf9c51/5a190/27new.png\" alt=\"bash screenshot of ls showing build directory\" srcset=\"/static/601890ece56718617e3d3e7b91bf9c51/772e8/27new.png 200w,\n/static/601890ece56718617e3d3e7b91bf9c51/e17e5/27new.png 400w,\n/static/601890ece56718617e3d3e7b91bf9c51/5a190/27new.png 800w,\n/static/601890ece56718617e3d3e7b91bf9c51/11b93/27new.png 1124w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>To make express show <i>static content</i>, the page <i>index.html</i> and the JavaScript, etc., it fetches, we need a built-in middleware from express called <a href=\"http://expressjs.com/en/starter/static-files.html\">static</a>.</p>\n<p>When we add the following amidst the declarations of middlewares</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>whenever express gets an HTTP GET request it will first check if the <i>build</i> directory contains a file corresponding to the request's address. If a correct file is found, express will return it. </p>\n<p>Now HTTP GET requests to the address <i>www.serversaddress.com/index.html</i> or <i>www.serversaddress.com</i> will show the React frontend. GET requests to the address <i>www.serversaddress.com/api/notes</i> will be handled by the backend's code.</p>\n<p>Because of our situation, both the frontend and the backend are at the same address, we can declare <em>baseUrl</em> as a <a href=\"https://www.w3.org/TR/WD-html40-970917/htmlweb.html#h-5.1.2\">relative</a> URL. This means we can leave out the part declaring the server. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'/api/notes'</span></span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getAll</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>baseUrl<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span></code></pre></div>\n<p>After the change, we have to create a new production build and copy it to the root of the backend repository. </p>\n<p>The application can now be used from the <i>backend</i> address <a href=\"http://localhost:3001\">http://localhost:3001</a>:</p>\n<picture><img src=\"/static/00b60846d754ead099038271e2e54ecc/5a190/28new.png\" alt=\"Notes application screenshot\" srcset=\"/static/00b60846d754ead099038271e2e54ecc/772e8/28new.png 200w,\n/static/00b60846d754ead099038271e2e54ecc/e17e5/28new.png 400w,\n/static/00b60846d754ead099038271e2e54ecc/5a190/28new.png 800w,\n/static/00b60846d754ead099038271e2e54ecc/c1b63/28new.png 1200w,\n/static/00b60846d754ead099038271e2e54ecc/29007/28new.png 1600w,\n/static/00b60846d754ead099038271e2e54ecc/ca3c3/28new.png 1850w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Our application now works exactly like the <a href=\"/en/part0/fundamentals_of_web_apps#single-page-app\">single-page app</a> example application we studied in part 0. </p>\n<p>When we use a browser to go to the address <a href=\"http://localhost:3001\">http://localhost:3001</a>, the server returns the <i>index.html</i> file from the <i>build</i> repository. The summarized contents of the file are as follows: </p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>React App<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/css/main.f9a47af2.chunk.css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>root<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/js/1.578f4ea1.chunk.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/js/main.104ca08d.chunk.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The file contains instructions to fetch a CSS stylesheet defining the styles of the application, and two <i>script</i> tags that instruct the browser to fetch the JavaScript code of the application - the actual React application. </p>\n<p>The React code fetches notes from the server address <a href=\"http://localhost:3001/api/notes\">http://localhost:3001/api/notes</a> and renders them to the screen. The communications between the server and the browser can be seen in the <i>Network</i> tab of the developer console:</p>\n<picture><img src=\"/static/7e90543c1d9697b1058225a877364cb9/5a190/29new.png\" alt=\"Network tab of notes application on backend\" srcset=\"/static/7e90543c1d9697b1058225a877364cb9/772e8/29new.png 200w,\n/static/7e90543c1d9697b1058225a877364cb9/e17e5/29new.png 400w,\n/static/7e90543c1d9697b1058225a877364cb9/5a190/29new.png 800w,\n/static/7e90543c1d9697b1058225a877364cb9/c1b63/29new.png 1200w,\n/static/7e90543c1d9697b1058225a877364cb9/29007/29new.png 1600w,\n/static/7e90543c1d9697b1058225a877364cb9/9e7e4/29new.png 2056w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>The setup that is ready for a product deployment looks as follows:</p>\n<picture><img src=\"/static/6f33425b60b49278d57df7e62f81a32c/db910/101.png\" alt=\"diagram of deployment ready react app\" srcset=\"/static/6f33425b60b49278d57df7e62f81a32c/772e8/101.png 200w,\n/static/6f33425b60b49278d57df7e62f81a32c/db910/101.png 396w\" sizes=\"(max-width: 396px) 100vw, 396px\"></picture>\n<p>Unlike when running the app in a development environment, everything is now in the same node/express-backend that runs in localhost:3001. When the browser goes to the page, the file <i>index.html</i> is rendered. That causes the browser to fetch the product version of the React app. Once it starts to run, it fetches the json-data from the address localhost:3001/api/notes.</p>\n<h3>The whole app to the internet</h3>\n<p>After ensuring that the production version of the application works locally, commit the production build of the frontend to the backend repository, and push the code to GitHub again.</p>\n<p>If you are using Render a push to GitHub <i>might</i> be enough. If the automatic deployment does not work, select the \"manual deploy\" from the Render dashboard.</p>\n<p>In the case of Fly.io the new deployment is done with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly deploy</code></pre></div>\n<p>The application works perfectly, except we haven't added the functionality for changing the importance of a note to the backend yet. </p>\n<picture><img src=\"/static/7003b3eacf4ce56213d8be4bea2df167/5a190/30new.png\" alt=\"screenshot of notes application\" srcset=\"/static/7003b3eacf4ce56213d8be4bea2df167/772e8/30new.png 200w,\n/static/7003b3eacf4ce56213d8be4bea2df167/e17e5/30new.png 400w,\n/static/7003b3eacf4ce56213d8be4bea2df167/5a190/30new.png 800w,\n/static/7003b3eacf4ce56213d8be4bea2df167/c1b63/30new.png 1200w,\n/static/7003b3eacf4ce56213d8be4bea2df167/29007/30new.png 1600w,\n/static/7003b3eacf4ce56213d8be4bea2df167/8454b/30new.png 1798w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Our application saves the notes to a variable. If the application crashes or is restarted, all of the data will disappear. </p>\n<p>The application needs a database. Before we introduce one, let's go through a few things. </p>\n<p>The setup looks like now as follows:</p>\n<picture><img src=\"/static/26dbec11959a8d1418e81b31e11624d0/5a190/102.png\" alt=\"diagram of react app on heroku with a database\" srcset=\"/static/26dbec11959a8d1418e81b31e11624d0/772e8/102.png 200w,\n/static/26dbec11959a8d1418e81b31e11624d0/e17e5/102.png 400w,\n/static/26dbec11959a8d1418e81b31e11624d0/5a190/102.png 800w,\n/static/26dbec11959a8d1418e81b31e11624d0/525d3/102.png 1090w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>The node/express-backend now resides in the Fly.io/Render server. When the root address is accessed, the browser loads and executes the React app that fetches the json-data from the Fly.io/Render server.</p>\n<h3>Streamlining deploying of the frontend</h3>\n<p>To create a new production build of the frontend without extra manual work, let's add some npm-scripts to the <i>package.json</i> of the backend repository.</p>\n<h4>Fly.io</h4>\n<p>The script looks like this</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token property\">\"build:ui\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf build &amp;&amp; cd ../part2-notes/ &amp;&amp; npm run build &amp;&amp; cp -r build ../notes-backend\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fly deploy\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy:full\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run build:ui &amp;&amp; npm run deploy\"</span><span class=\"token punctuation\">,</span>    \n    <span class=\"token property\">\"logs:prod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fly logs\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The script <em>npm run build:ui</em> builds the frontend and copies the production version under the backend repository.  <em>npm run deploy</em> releases the current backend to Fly.io. </p>\n<p><em>npm run deploy:full</em> combines these two scripts. </p>\n<p>There is also a script <em>npm run logs:prod</em> to show the Fly.io logs.</p>\n<p>Note that the directory paths in the script <i>build:ui</i> depend on the location of repositories in the file system.</p>\n<h4>Render</h4>\n<p>In case of Render, the scripts look like the following</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...</span>\n    <span class=\"token property\">\"build:ui\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf build &amp;&amp; cd ../frontend &amp;&amp; npm run build &amp;&amp; cp -r build ../backend\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy:full\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run build:ui &amp;&amp; git add . &amp;&amp; git commit -m uibuild &amp;&amp; git push\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The script <em>npm run build:ui</em> builds the frontend and copies the production version under the backend repository. <em>npm run deploy:full</em> contains also the necessary <i>git</i> commands to update the backend repository. </p>\n<p>Note that the directory paths in the script <i>build:ui</i> depend on the location of repositories in the file system.</p>\n<blockquote>\n<p><strong>NB</strong>  On Windows, npm scripts are executed in cmd.exe as the default shell which does not support bash commands. For the above bash commands to work, you can change the default shell to Bash (in the default Git for Windows installation) as follows:</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">npm config set script-shell \"C:\\\\Program Files\\\\git\\\\bin\\\\bash.exe\"</code></pre></div>\n<p>Another option is the use of <a href=\"https://www.npmjs.com/package/shx\">shx</a>.</p>\n<h3>Proxy</h3>\n<p>Changes on the frontend have caused it to no longer work in development mode (when started with command <em>npm start</em>), as the connection to the backend does not work. </p>\n<picture><img src=\"/static/c2dc22eab2be6e45278c02055c079123/5a190/32new.png\" alt=\"Network dev tools showing a 404 on getting notes\" srcset=\"/static/c2dc22eab2be6e45278c02055c079123/772e8/32new.png 200w,\n/static/c2dc22eab2be6e45278c02055c079123/e17e5/32new.png 400w,\n/static/c2dc22eab2be6e45278c02055c079123/5a190/32new.png 800w,\n/static/c2dc22eab2be6e45278c02055c079123/c1b63/32new.png 1200w,\n/static/c2dc22eab2be6e45278c02055c079123/29007/32new.png 1600w,\n/static/c2dc22eab2be6e45278c02055c079123/17d12/32new.png 1666w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>This is due to changing the backend address to a relative URL: </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'/api/notes'</span></code></pre></div>\n<p>Because in development mode the frontend is at the address <i>localhost:3000</i>, the requests to the backend go to the wrong address <i>localhost:3000/api/notes</i>. The backend is at <i>localhost:3001</i>. </p>\n<p>If the project was created with create-react-app, this problem is easy to solve. It is enough to add the following declaration to the <i>package.json</i> file of the frontend repository. </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"dependencies\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    // <span class=\"token punctuation\">..</span>.\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"scripts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    // <span class=\"token punctuation\">..</span>.\n  <span class=\"token punctuation\">}</span>,\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token string\">\"proxy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"http://localhost:3001\"</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>After a restart, the React development environment will work as a <a href=\"https://create-react-app.dev/docs/proxying-api-requests-in-development/\">proxy</a>. If the React code does an HTTP request to a server address at <i><a href=\"http://localhost:3000\">http://localhost:3000</a></i> not managed by the React application itself (i.e. when requests are not about fetching the CSS or JavaScript of the application), the request will be redirected to the server at <i><a href=\"http://localhost:3001\">http://localhost:3001</a></i>. </p>\n<p>Now the frontend is also fine, working with the server both in development- and production mode. </p>\n<p>A negative aspect of our approach is how complicated it is to deploy the frontend. Deploying a new version requires generating a new production build of the frontend and copying it to the backend repository. This makes creating an automated <a href=\"https://martinfowler.com/bliki/DeploymentPipeline.html\">deployment pipeline</a> more difficult. Deployment pipeline means an automated and controlled way to move the code from the computer of the developer through different tests and quality checks to the production environment. Building a deployment pipeline is the topic of <a href=\"https://fullstackopen.com/en/part11\">part 11</a> of this course.</p>\n<p>There are multiple ways to achieve this (for example placing both backend and frontend code <a href=\"https://github.com/mars/heroku-cra-node\">in the same repository</a> ) but we will not go into those now. </p>\n<p>In some situations, it may be sensible to deploy the frontend code as its own application. With apps created with create-react-app it is <a href=\"https://github.com/mars/create-react-app-buildpack\">straightforward</a>.</p>\n<p>The current backend code can be found on <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-3\">Github</a>, in the branch <i>part3-3</i>. The changes in frontend code are in <i>part3-1</i> branch of the <a href=\"https://github.com/fullstack-hy2020/part2-notes/tree/part3-1\">frontend repository</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Exercises 3.9.-3.11.</h3>\n<p>The following exercises don't require many lines of code. They can however be challenging, because you must understand exactly what is happening and where, and the configurations must be just right. </p>\n<h4>3.9 phonebook backend step9</h4>\n<p>Make the backend work with the phonebook frontend from the exercises of the previous part. Do not implement the functionality for making changes to the phone numbers yet, that will be implemented in exercise 3.17. </p>\n<p>You will probably have to do some small changes to the frontend, at least to the URLs for the backend. Remember to keep the developer console open in your browser. If some HTTP requests fail, you should check from the <i>Network</i>-tab what is going on. Keep an eye on the backend's console as well. If you did not do the previous exercise, it is worth it to print the request data or <i>request.body</i> to the console in the event handler responsible for POST requests. </p>\n<h4>3.10 phonebook backend step10</h4>\n<p>Deploy the backend to the internet, for example to Fly.io or Render. </p>\n<p>Test the deployed backend with a browser and Postman or VS Code REST client to ensure it works. </p>\n<p><strong>PRO TIP:</strong> When you deploy your application to Internet, it is worth it to at least in the beginning keep an eye on the logs of the application <strong>AT ALL TIMES</strong>.</p>\n<p>Create a README.md at the root of your repository, and add a link to your online application to it. </p>\n<h4>3.11 phonebook full stack</h4>\n<p>Generate a production build of your frontend, and add it to the internet application using the method introduced in this part. </p>\n<p><strong>NB</strong> If you use Render, make sure the directory <i>build</i> is not gitignored</p>\n<p>Also, make sure that the frontend still works locally (in development mode when started with command <em>npm start</em>). </p>\n<p>If you have problems getting the app working make sure that your directory structure matches <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-3\">the example app</a>.</p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/8ac7bc0fb2b7018a7853b00c454b2103/part-3.svg"},"part":3,"letter":"b","lang":"en"}}},"pageContext":{"part":3,"letter":"b","lang":"en"}},"staticQueryHashes":["3128451518"]}